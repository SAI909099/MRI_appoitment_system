{% extends "base.html" %}
{% block title %}Bemorlar ro‘yxati{% endblock %}

{% block content %}
<h1>Bemorlar ro‘yxati</h1>

<form method="get">
    <input type="date" name="date" value="{{ current_date }}">
    <input type="text" name="search" placeholder="Qidirish..." value="{{ request.GET.search }}">
    <button type="submit">Filter</button>
</form>

<table>
    <thead>
        <tr>
            <th>Navbat raqami</th>
            <th>Ism</th>
            <th>Familiya</th>
            <th>Tug‘ilgan yil</th>
            <th>Telefon</th>
            <th>Skani qilingan joylar</th>
            <th>To‘lov holati</th>
            <th>Amallar</th>
        </tr>
    </thead>
    <tbody>
        {% for patient in patients %}
        <tr data-patient-id="{{ patient.id }}"
            data-first-name="{{ patient.first_name }}"
            data-last-name="{{ patient.last_name }}"
            data-birth-year="{{ patient.birth_year }}"
            data-phone-number="{{ patient.phone_number }}"
            data-partial-paid="{{ patient.partial_paid }}"
            data-paid="{{ patient.paid|yesno:"true,false" }}"
            data-body-parts="{% for bp in patient.body_parts.all %}{{ bp.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
            <td>{{ patient.appointment_number }}</td>
            <td>{{ patient.first_name }}</td>
            <td>{{ patient.last_name }}</td>
            <td>{{ patient.birth_year }}</td>
            <td>{{ patient.phone_number }}</td>
            <td>
                {% for bp in patient.body_parts.all %}
                    {{ bp.name }} ({{ bp.price }} so'm){% if not forloop.last %}, {% endif %}
                {% endfor %}
            </td>
            <td class="{% if not patient.paid and patient.partial_paid == 0 %}unpaid{% elif patient.partial_paid > 0 and not patient.paid %}partial{% else %}paid{% endif %}">
                {{ patient.partial_paid }} so'm / {{ patient.paid|yesno:"To‘langan,To‘lanmagan" }}
            </td>
            <td>
                <button type="button" onclick="openEditModal(this)">Tahrirlash</button>
                <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="patient_id" value="{{ patient.id }}">
                    {% if not patient.finished %}
                        <button type="submit" name="action" value="call">Chaqirish</button>
                        <button type="submit" name="action" value="not_here">Yo‘q</button>
                        <button type="submit" name="action" value="done">Tugallangan</button>
                    {% else %}
                        <span style="color: green; font-weight: bold;">Tugallangan</span>
                    {% endif %}
                    <button type="submit" name="action" value="delete" onclick="return confirm('Butunlay o‘chirishni xohlaysizmi?')">O‘chirish</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Edit Modal -->
<div id="editModal" style="display:none; position:fixed; top:10%; left:30%; background:white; padding:20px; border:1px solid #ccc; z-index:1000;">
    <h2>Bemorni tahrirlash</h2>
    <form method="post" id="editForm">
        {% csrf_token %}
        <input type="hidden" name="action" value="edit">
        <input type="hidden" name="patient_id" id="editPatientId">

        <div class="form-group">
            <input type="text" name="first_name" id="editFirstName" placeholder="Ism" required>
        </div>
        <div class="form-group">
            <input type="text" name="last_name" id="editLastName" placeholder="Familiya" required>
        </div>
        <div class="form-group">
            <input type="number" name="birth_year" id="editBirthYear" placeholder="Tug‘ilgan yil" required>
        </div>
        <div class="form-group">
            <input type="text" name="phone_number" id="editPhoneNumber" placeholder="Telefon raqami">
        </div>
        <div class="form-group">
            <h4>Skani qilinadigan joylar:</h4>
            {% for bp in body_parts %}
                <label>
                    <input type="checkbox" name="body_parts" value="{{ bp.id }}" class="editBodyPart" data-price="{{ bp.price }}">
                    {{ bp.name }} ({{ bp.price }} so'm)
                </label><br>
            {% endfor %}
            <p><strong>Jami narx:</strong> <span id="editTotalPrice">0</span> so'm</p>
        </div>
        <div class="form-group">
            <input type="number" step="0.01" name="partial_paid" id="editPartialPaid" placeholder="To'lov miqdori" required>
            <label><input type="checkbox" name="paid" id="editPaid"> To‘langan</label>
        </div>
        <button type="submit">Saqlash</button>
        <button type="button" onclick="closeEditModal()">Bekor qilish</button>
    </form>
</div>

<!-- Overlay -->
<div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:999;" onclick="closeEditModal()"></div>

<script>
function openEditModal(button) {
    const row = button.closest('tr');

    const id = row.dataset.patientId;
    const firstName = row.dataset.firstName;
    const lastName = row.dataset.lastName;
    const birthYear = row.dataset.birthYear;
    const phoneNumber = row.dataset.phoneNumber;
    const paid = row.dataset.paid === "true";
    const partialPaid = row.dataset.partialPaid;
    const bodyParts = row.dataset.bodyParts.split(',');

    document.getElementById('editPatientId').value = id;
    document.getElementById('editFirstName').value = firstName;
    document.getElementById('editLastName').value = lastName;
    document.getElementById('editBirthYear').value = birthYear;
    document.getElementById('editPhoneNumber').value = phoneNumber;
    document.getElementById('editPartialPaid').value = partialPaid;
    document.getElementById('editPaid').checked = paid;

    document.querySelectorAll('.editBodyPart').forEach(cb => {
        cb.checked = bodyParts.includes(cb.value);
    });

    updateTotalPrice();
    document.getElementById('editModal').style.display = 'block';
    document.getElementById('modalOverlay').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    document.getElementById('modalOverlay').style.display = 'none';
}

function updateTotalPrice() {
    let total = 0;
    document.querySelectorAll('.editBodyPart').forEach(cb => {
        if (cb.checked) {
            total += parseFloat(cb.dataset.price);
        }
    });
    document.getElementById('editTotalPrice').textContent = total.toFixed(2);
}

document.querySelectorAll('.editBodyPart').forEach(cb => {
    cb.addEventListener('change', updateTotalPrice);
});
</script>

<h3>Qisman to‘lov qilganlar:</h3>
<ul>
    {% for patient in patients %}
    {% if patient.partial_paid > 0 and not patient.paid %}
        <li>{{ patient.appointment_number }} - {{ patient.first_name }} {{ patient.last_name }}</li>
    {% endif %}
    {% endfor %}
</ul>

<h3>To‘lov qilmaganlar:</h3>
<ul>
    {% for patient in patients %}
    {% if not patient.paid and patient.partial_paid == 0 %}
        <li>{{ patient.appointment_number }} - {{ patient.first_name }} {{ patient.last_name }}</li>
    {% endif %}
    {% endfor %}
</ul>
{% endblock %}
